<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:Aihao.ViewModels"
             mc:Ignorable="d" d:DesignWidth="500" d:DesignHeight="400"
             x:Class="Aihao.Views.JsonPropertyEditor"
             x:DataType="vm:JsonPropertyEditorViewModel">
    
    <UserControl.Styles>
        <!-- Node container styling -->
        <Style Selector="Border.property-node">
            <Setter Property="Padding" Value="4,2"/>
            <Setter Property="Margin" Value="0,1"/>
            <Setter Property="CornerRadius" Value="3"/>
        </Style>
        <Style Selector="Border.property-node:pointerover">
            <Setter Property="Background" Value="{DynamicResource SystemControlHighlightListLowBrush}"/>
        </Style>
        <Style Selector="Border.property-node.modified">
            <Setter Property="Background" Value="#20FFA500"/>
        </Style>
        
        <!-- Compact input styling -->
        <Style Selector="TextBox.property-value">
            <Setter Property="Padding" Value="4,2"/>
            <Setter Property="MinHeight" Value="24"/>
            <Setter Property="FontFamily" Value="Consolas, Menlo, monospace"/>
            <Setter Property="FontSize" Value="12"/>
        </Style>
        <Style Selector="TextBox.property-name">
            <Setter Property="Padding" Value="4,2"/>
            <Setter Property="MinHeight" Value="24"/>
            <Setter Property="FontFamily" Value="Consolas, Menlo, monospace"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
        </Style>
        <Style Selector="ComboBox.property-type">
            <Setter Property="Padding" Value="4,2"/>
            <Setter Property="MinHeight" Value="24"/>
            <Setter Property="FontSize" Value="11"/>
        </Style>
        <Style Selector="NumericUpDown.vector-component">
            <Setter Property="Width" Value="70"/>
            <Setter Property="ShowButtonSpinner" Value="False"/>
            <Setter Property="FormatString" Value="0.##"/>
        </Style>
        <Style Selector="NumericUpDown.resolution-component">
            <Setter Property="Width" Value="65"/>
            <Setter Property="ShowButtonSpinner" Value="False"/>
            <Setter Property="FormatString" Value="0"/>
            <Setter Property="Minimum" Value="1"/>
            <Setter Property="Maximum" Value="9999"/>
        </Style>
    </UserControl.Styles>
    
    <DockPanel>
        <!-- Toolbar -->
        <Border DockPanel.Dock="Top" 
                Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                Padding="4,2"
                IsVisible="{Binding ShowToolbar}">
            <Grid ColumnDefinitions="Auto,*,Auto,Auto">
                <Button Grid.Column="0"
                        Command="{Binding AddPropertyCommand}"
                        Content="+ Add"
                        Padding="8,2"
                        FontSize="11"
                        IsVisible="{Binding AllowAddRemove}"/>
                
                <TextBox Grid.Column="1"
                         Text="{Binding SearchText}"
                         Watermark="ðŸ” Search..."
                         Margin="8,0"
                         Padding="4,2"
                         FontSize="11"/>
                
                <Button Grid.Column="2"
                        Command="{Binding ExpandAllCommand}"
                        Content="âŠž"
                        ToolTip.Tip="Expand All"
                        Padding="6,2"
                        FontSize="11"/>
                <Button Grid.Column="3"
                        Command="{Binding CollapseAllCommand}"
                        Content="âŠŸ"
                        ToolTip.Tip="Collapse All"
                        Padding="6,2"
                        Margin="2,0,0,0"
                        FontSize="11"/>
            </Grid>
        </Border>
        
        <!-- Tree View -->
        <TreeView ItemsSource="{Binding RootNodes}"
                  SelectedItem="{Binding SelectedNode}"
                  Padding="4">
            <TreeView.Styles>
                <Style Selector="TreeViewItem" x:DataType="vm:PropertyNodeViewModel">
                    <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                </Style>
            </TreeView.Styles>
            
            <TreeView.ItemTemplate>
                <TreeDataTemplate ItemsSource="{Binding Children}" x:DataType="vm:PropertyNodeViewModel">
                    <Border Classes="property-node"
                            Classes.modified="{Binding IsModified}"
                            ToolTip.Tip="{Binding ValidationError}">
                        <Grid ColumnDefinitions="Auto,Auto,*,Auto,Auto" MinHeight="26">
                            <!-- Icon -->
                            <TextBlock Grid.Column="0"
                                       Text="{Binding Icon}"
                                       VerticalAlignment="Center"
                                       FontSize="12"
                                       Width="20"
                                       Margin="0,0,4,0"/>
                            
                            <!-- Name (editable for object properties, display-only for array items) -->
                            <TextBox Grid.Column="1"
                                     Text="{Binding Name}"
                                     Classes="property-name"
                                     IsVisible="{Binding !IsArrayElement}"
                                     MinWidth="80"
                                     MaxWidth="150"
                                     Margin="0,0,8,0"
                                     VerticalAlignment="Center"/>
                            <TextBlock Grid.Column="1"
                                       Text="{Binding DisplayName}"
                                       IsVisible="{Binding IsArrayElement}"
                                       FontFamily="Consolas, Menlo, monospace"
                                       FontWeight="SemiBold"
                                       VerticalAlignment="Center"
                                       Margin="0,0,8,0"
                                       Opacity="0.7"/>
                            
                            <!-- Value area -->
                            <Panel Grid.Column="2" VerticalAlignment="Center">
                                
                                <!-- === SPECIAL EDITORS === -->
                                
                                <!-- Resolution Editor (WxH) -->
                                <StackPanel Orientation="Horizontal"
                                            IsVisible="{Binding IsResolutionEditor}"
                                            Spacing="2">
                                    <NumericUpDown Value="{Binding ResolutionWidth}"
                                                   Classes="resolution-component"/>
                                    <TextBlock Text="Ã—" VerticalAlignment="Center" Margin="2,0"/>
                                    <NumericUpDown Value="{Binding ResolutionHeight}"
                                                   Classes="resolution-component"/>
                                </StackPanel>
                                
                                <!-- Vector2 Editor (X,Y) -->
                                <StackPanel Orientation="Horizontal"
                                            IsVisible="{Binding IsVector2Editor}"
                                            Spacing="2">
                                    <TextBlock Text="X" VerticalAlignment="Center" Opacity="0.6" FontSize="11"/>
                                    <NumericUpDown Value="{Binding VectorX}"
                                                   Classes="vector-component"/>
                                    <TextBlock Text="Y" VerticalAlignment="Center" Opacity="0.6" FontSize="11" Margin="4,0,0,0"/>
                                    <NumericUpDown Value="{Binding VectorY}"
                                                   Classes="vector-component"/>
                                </StackPanel>
                                
                                <!-- Vector3 Editor (X,Y,Z) -->
                                <StackPanel Orientation="Horizontal"
                                            IsVisible="{Binding IsVector3Editor}"
                                            Spacing="2">
                                    <TextBlock Text="X" VerticalAlignment="Center" Opacity="0.6" FontSize="11"/>
                                    <NumericUpDown Value="{Binding VectorX}"
                                                   Classes="vector-component"
                                                   Width="60"/>
                                    <TextBlock Text="Y" VerticalAlignment="Center" Opacity="0.6" FontSize="11" Margin="2,0,0,0"/>
                                    <NumericUpDown Value="{Binding VectorY}"
                                                   Classes="vector-component"
                                                   Width="60"/>
                                    <TextBlock Text="Z" VerticalAlignment="Center" Opacity="0.6" FontSize="11" Margin="2,0,0,0"/>
                                    <NumericUpDown Value="{Binding VectorZ}"
                                                   Classes="vector-component"
                                                   Width="60"/>
                                </StackPanel>
                                
                                <!-- Color Editor -->
                                <StackPanel Orientation="Horizontal"
                                            IsVisible="{Binding IsColorEditor}"
                                            Spacing="4">
                                    <Border Width="24" Height="24"
                                            CornerRadius="3"
                                            BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                            BorderThickness="1"
                                            Background="{Binding Value, Converter={x:Static vm:HexToColorConverter.Instance}}"/>
                                    <TextBox Text="{Binding Value}"
                                             Classes="property-value"
                                             Width="90"
                                             Watermark="#RRGGBB"/>
                                </StackPanel>
                                
                                <!-- Slider Editor -->
                                <StackPanel Orientation="Horizontal"
                                            IsVisible="{Binding IsSliderEditor}"
                                            Spacing="4">
                                    <Slider Value="{Binding SliderValue}"
                                            Minimum="0"
                                            Maximum="1"
                                            Width="100"
                                            VerticalAlignment="Center"/>
                                    <TextBlock Text="{Binding Value}"
                                               Width="50"
                                               VerticalAlignment="Center"
                                               FontFamily="Consolas, Menlo, monospace"
                                               FontSize="11"/>
                                </StackPanel>
                                
                                <!-- === DEFAULT EDITORS === -->
                                
                                <!-- Boolean toggle -->
                                <CheckBox IsChecked="{Binding BoolValue}"
                                          Content="{Binding Value}"
                                          IsVisible="{Binding IsBooleanType}"
                                          VerticalAlignment="Center"/>
                                
                                <!-- Null indicator -->
                                <TextBlock Text="null"
                                           Opacity="0.5"
                                           FontStyle="Italic"
                                           IsVisible="{Binding IsNullType}"
                                           VerticalAlignment="Center"/>
                                
                                <!-- Default text editor (string/number without special format) -->
                                <TextBox Text="{Binding Value}"
                                         Classes="property-value"
                                         IsVisible="{Binding ShowDefaultTextEditor}"
                                         MinWidth="100"
                                         BorderBrush="{Binding ValidationError, Converter={x:Static vm:ErrorBorderConverter.Instance}}"/>
                                
                                <!-- Branch: Show summary and add button -->
                                <StackPanel Orientation="Horizontal" 
                                            IsVisible="{Binding IsBranch}"
                                            Spacing="8">
                                    <TextBlock Text="{Binding Summary}"
                                               Opacity="0.6"
                                               FontSize="11"
                                               VerticalAlignment="Center"/>
                                    <Button Content="+"
                                            Command="{Binding AddChildCommand}"
                                            Padding="6,1"
                                            FontSize="11"
                                            ToolTip.Tip="Add child"
                                            IsVisible="{Binding $parent[UserControl].((vm:JsonPropertyEditorViewModel)DataContext).AllowAddRemove}"/>
                                </StackPanel>
                            </Panel>
                            
                            <!-- Modified indicator -->
                            <Ellipse Grid.Column="3"
                                     Width="6" Height="6"
                                     Fill="Orange"
                                     VerticalAlignment="Center"
                                     Margin="4,0"
                                     IsVisible="{Binding IsModified}"/>
                            
                            <!-- Remove button -->
                            <Button Grid.Column="4"
                                    Content="Ã—"
                                    Command="{Binding RemoveCommand}"
                                    Padding="4,0"
                                    FontSize="12"
                                    Background="Transparent"
                                    ToolTip.Tip="Remove"
                                    IsVisible="{Binding $parent[UserControl].((vm:JsonPropertyEditorViewModel)DataContext).AllowAddRemove}"/>
                        </Grid>
                    </Border>
                </TreeDataTemplate>
            </TreeView.ItemTemplate>
        </TreeView>
    </DockPanel>
</UserControl>
