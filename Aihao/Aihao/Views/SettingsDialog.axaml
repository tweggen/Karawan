<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="using:Aihao.ViewModels"
        xmlns:models="using:Aihao.Models"
        mc:Ignorable="d" d:DesignWidth="700" d:DesignHeight="500"
        x:Class="Aihao.Views.SettingsDialog"
        x:DataType="vm:SettingsDialogViewModel"
        Title="Settings"
        Width="700" Height="500"
        MinWidth="500" MinHeight="350"
        WindowStartupLocation="CenterOwner"
        CanResize="True"
        Background="{StaticResource EditorBackgroundBrush}">
    
    <Window.KeyBindings>
        <KeyBinding Gesture="Escape" Command="{Binding CancelCommand}"/>
        <KeyBinding Gesture="Ctrl+S" Command="{Binding SaveCommand}"/>
    </Window.KeyBindings>
    
    <Window.Resources>
        <!-- Setting item template -->
        <DataTemplate x:Key="SettingItemTemplate" x:DataType="vm:SettingsItemVM">
            <Border Padding="0,6" 
                    BorderBrush="{StaticResource ToolbarBackgroundBrush}"
                    BorderThickness="0,0,0,1">
                <Grid RowDefinitions="Auto,Auto">
                    <!-- Header: name, description, modified indicator -->
                    <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                        <StackPanel Grid.Column="0" Spacing="1">
                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <TextBlock Text="{Binding DisplayName}" 
                                           FontWeight="SemiBold"/>
                                <TextBlock Text="●" 
                                           Foreground="{StaticResource AccentBrush}" 
                                           IsVisible="{Binding IsModified}"
                                           ToolTip.Tip="Modified"/>
                                <TextBlock Text="⟳" 
                                           Foreground="Orange" 
                                           IsVisible="{Binding RequiresRestart}"
                                           ToolTip.Tip="Requires restart"/>
                            </StackPanel>
                            <TextBlock Text="{Binding Description}" 
                                       Opacity="0.6" 
                                       TextWrapping="Wrap"
                                       MaxWidth="400"/>
                        </StackPanel>
                        
                        <!-- JSON path (subtle) -->
                        <TextBlock Grid.Column="1"
                                   Text="{Binding JsonPath}"
                                   Opacity="0.25"
                                   FontFamily="Consolas,Menlo,monospace"
                                   VerticalAlignment="Top"
                                   Margin="8,0,0,0"/>
                    </Grid>
                    
                    <!-- Editor control based on type - only one will be visible -->
                    <StackPanel Grid.Row="1" Margin="0,4,0,0">
                        <!-- String -->
                        <TextBox Text="{Binding StringValue}"
                                 IsVisible="{Binding Type, Converter={x:Static vm:SettingsTypeConverter.IsString}}"
                                 MaxWidth="350"
                                 HorizontalAlignment="Left"/>
                        
                        <!-- Bool -->
                        <ToggleSwitch IsChecked="{Binding BoolValue}"
                                      IsVisible="{Binding Type, Converter={x:Static vm:SettingsTypeConverter.IsBool}}"
                                      HorizontalAlignment="Left"/>
                        
                        <!-- Int -->
                        <NumericUpDown Value="{Binding DecimalValue}"
                                       Minimum="{Binding MinValueDecimal}"
                                       Maximum="{Binding MaxValueDecimal}"
                                       IsVisible="{Binding Type, Converter={x:Static vm:SettingsTypeConverter.IsInt}}"
                                       FormatString="0"
                                       Width="120"
                                       HorizontalAlignment="Left"/>
                        
                        <!-- Choice -->
                        <ComboBox ItemsSource="{Binding Choices}"
                                  SelectedValue="{Binding StringValue}"
                                  SelectedValueBinding="{Binding Value}"
                                  IsVisible="{Binding Type, Converter={x:Static vm:SettingsTypeConverter.IsChoice}}"
                                  MinWidth="150"
                                  HorizontalAlignment="Left">
                            <ComboBox.ItemTemplate>
                                <DataTemplate x:DataType="models:ChoiceOption">
                                    <TextBlock Text="{Binding DisplayName}"/>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                        
                        <!-- Path -->
                        <Grid ColumnDefinitions="*,Auto"
                              IsVisible="{Binding Type, Converter={x:Static vm:SettingsTypeConverter.IsPath}}"
                              MaxWidth="400"
                              HorizontalAlignment="Left">
                            <TextBox Grid.Column="0" Text="{Binding StringValue}" Margin="0,0,4,0"/>
                            <Button Grid.Column="1" Content="Browse..."/>
                        </Grid>
                    </StackPanel>
                </Grid>
            </Border>
        </DataTemplate>
    </Window.Resources>
    
    <DockPanel>
        <!-- Bottom buttons -->
        <Border DockPanel.Dock="Bottom" 
                Background="{StaticResource ToolbarBackgroundBrush}" 
                Padding="8,6">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <!-- Reset button -->
                <Button Grid.Column="0" 
                        Content="Reset All" 
                        Command="{Binding ResetToDefaultsCommand}"
                        ToolTip.Tip="Reset all settings to their default values"/>
                
                <!-- Restart warning -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" 
                            HorizontalAlignment="Center" 
                            IsVisible="{Binding HasRestartRequired}"
                            Spacing="4">
                    <TextBlock Text="⚠️" Foreground="Orange" VerticalAlignment="Center"/>
                    <TextBlock Text="Some changes require restart" 
                               Foreground="Orange" 
                               VerticalAlignment="Center"/>
                </StackPanel>
                
                <!-- Save/Cancel -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4">
                    <Button Content="Cancel" 
                            Command="{Binding CancelCommand}"
                            MinWidth="60"/>
                    <Button Content="Save" 
                            Command="{Binding SaveCommand}"
                            IsEnabled="{Binding HasChanges}"
                            MinWidth="60"
                            Classes="accent"/>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Main content -->
        <Grid ColumnDefinitions="180,1,*">
            <!-- Left: Section tree -->
            <Border Grid.Column="0" Background="{StaticResource PanelBackgroundBrush}">
                <DockPanel>
                    <!-- Search box -->
                    <Border DockPanel.Dock="Top" Padding="4">
                        <TextBox Text="{Binding SearchText}"
                                 Watermark="Search..."/>
                    </Border>
                    
                    <!-- Tree -->
                    <TreeView ItemsSource="{Binding Sections}"
                              SelectedItem="{Binding SelectedSection}"
                              Padding="2">
                        <TreeView.ItemTemplate>
                            <TreeDataTemplate ItemsSource="{Binding Children}" x:DataType="vm:SettingsSectionViewModel">
                                <StackPanel Orientation="Horizontal" Spacing="6" Margin="2">
                                    <TextBlock Text="{Binding Icon}"/>
                                    <TextBlock Text="{Binding DisplayName}" VerticalAlignment="Center"/>
                                </StackPanel>
                            </TreeDataTemplate>
                        </TreeView.ItemTemplate>
                    </TreeView>
                </DockPanel>
            </Border>
            
            <!-- Separator -->
            <Border Grid.Column="1" Background="{StaticResource ToolbarBackgroundBrush}"/>
            
            <!-- Right: Settings for selected section -->
            <Border Grid.Column="2" Background="{StaticResource EditorBackgroundBrush}">
                <DockPanel IsVisible="{Binding SelectedSection, Converter={x:Static ObjectConverters.IsNotNull}}">
                    <!-- Section header -->
                    <Border DockPanel.Dock="Top" 
                            Background="{StaticResource ToolbarBackgroundBrush}" 
                            Padding="8,4">
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="{Binding SelectedSection.Icon}" VerticalAlignment="Center"/>
                                <TextBlock Text="{Binding SelectedSection.DisplayName}" 
                                           FontWeight="SemiBold"
                                           VerticalAlignment="Center"/>
                            </StackPanel>
                            <Button Grid.Column="2" 
                                    Content="Reset Section" 
                                    Command="{Binding ResetSectionToDefaultsCommand}"
                                    ToolTip.Tip="Reset this section to defaults"/>
                        </Grid>
                    </Border>
                    
                    <!-- Settings list -->
                    <ScrollViewer HorizontalScrollBarVisibility="Disabled" 
                                  VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding SelectedSection.Items}"
                                      ItemTemplate="{StaticResource SettingItemTemplate}"
                                      Margin="8"/>
                    </ScrollViewer>
                </DockPanel>
            </Border>
        </Grid>
    </DockPanel>
</Window>
