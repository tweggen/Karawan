<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="using:Aihao.ViewModels"
        xmlns:views="using:Aihao.Views"
        mc:Ignorable="d" d:DesignWidth="1400" d:DesignHeight="900"
        x:Class="Aihao.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="{Binding Title}"
        Width="1400" Height="900"
        WindowStartupLocation="CenterScreen"
        Background="{StaticResource EditorBackgroundBrush}">
    
    <Window.KeyBindings>
        <KeyBinding Gesture="Ctrl+O" Command="{Binding OpenProjectCommand}"/>
        <KeyBinding Gesture="Ctrl+S" Command="{Binding SaveProjectCommand}"/>
        <KeyBinding Gesture="Ctrl+Shift+B" Command="{Binding BuildProjectCommand}"/>
        <KeyBinding Gesture="F5" Command="{Binding RunGameCommand}"/>
        <KeyBinding Gesture="Ctrl+F5" Command="{Binding DebugGameCommand}"/>
        <KeyBinding Gesture="Shift+F5" Command="{Binding StopGameCommand}"/>
        <KeyBinding Gesture="Ctrl+OemComma" Command="{Binding OpenSettingsCommand}"/>
        <KeyBinding Gesture="Ctrl+Shift+K" Command="{Binding OpenKeybindingsCommand}"/>
        <KeyBinding Gesture="Ctrl+P" Command="{Binding OpenQuickOpenCommand}"/>
        <KeyBinding Gesture="Ctrl+Shift+P" Command="{Binding OpenCommandPaletteCommand}"/>
    </Window.KeyBindings>
    
    <DockPanel>
        <!-- Menu Bar -->
        <Menu DockPanel.Dock="Top" Background="{StaticResource ToolbarBackgroundBrush}">
            <MenuItem Header="_File">
                <MenuItem Header="_Open Project..." Command="{Binding OpenProjectCommand}" InputGesture="Ctrl+O"/>
                <Separator/>
                <MenuItem Header="_Save Project" Command="{Binding SaveProjectCommand}" InputGesture="Ctrl+S" IsEnabled="{Binding IsProjectLoaded}"/>
                <MenuItem Header="Save Project _As..." Command="{Binding SaveProjectAsCommand}" IsEnabled="{Binding IsProjectLoaded}"/>
                <Separator/>
                <MenuItem Header="Recent Projects" ItemsSource="{Binding RecentProjects}" IsEnabled="{Binding RecentProjects.Count}">
                    <MenuItem.ItemTemplate>
                        <DataTemplate>
                            <MenuItem Header="{Binding Name}" 
                                      Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).OpenRecentProjectCommand}"
                                      CommandParameter="{Binding}"
                                      ToolTip.Tip="{Binding Path}"/>
                        </DataTemplate>
                    </MenuItem.ItemTemplate>
                </MenuItem>
                <MenuItem Header="Clear Recent Projects" Command="{Binding ClearRecentProjectsCommand}"/>
                <Separator/>
                <MenuItem Header="E_xit" Command="{Binding ExitCommand}"/>
            </MenuItem>
            <MenuItem Header="_Edit">
                <MenuItem Header="_Undo" IsEnabled="False"/>
                <MenuItem Header="_Redo" IsEnabled="False"/>
                <Separator/>
                <MenuItem Header="_Settings..." Command="{Binding OpenSettingsCommand}" InputGesture="Ctrl+,"/>
                <MenuItem Header="_Keyboard Shortcuts..." Command="{Binding OpenKeybindingsCommand}" InputGesture="Ctrl+Shift+K"/>
            </MenuItem>
            <MenuItem Header="_View">
                <MenuItem Header="_Quick Open..." Command="{Binding OpenQuickOpenCommand}" InputGesture="Ctrl+P"/>
                <MenuItem Header="_Command Palette..." Command="{Binding OpenCommandPaletteCommand}" InputGesture="Ctrl+Shift+P"/>
                <Separator/>
                <MenuItem Header="Project _Tree" />
                <MenuItem Header="_Console" Command="{Binding ShowConsoleCommand}"/>
                <MenuItem Header="P_roperties"/>
                <Separator/>
                <MenuItem Header="_Render Output" Command="{Binding OpenRenderWindowCommand}"/>
            </MenuItem>
            <MenuItem Header="_Project" IsEnabled="{Binding IsProjectLoaded}">
                <MenuItem Header="_Build" Command="{Binding BuildProjectCommand}" InputGesture="Ctrl+Shift+B"/>
                <Separator/>
                <MenuItem Header="_Global Settings" Command="{Binding OpenGlobalSettingsEditorCommand}"/>
                <MenuItem Header="_Resources" Command="{Binding OpenResourcesEditorCommand}"/>
                <MenuItem Header="_Metagen" Command="{Binding OpenMetagenEditorCommand}"/>
            </MenuItem>
            <MenuItem Header="_Run" IsEnabled="{Binding IsProjectLoaded}">
                <MenuItem Header="_Start" Command="{Binding RunGameCommand}" InputGesture="F5" IsEnabled="{Binding !IsGameRunning}"/>
                <MenuItem Header="Start with _Debugger" Command="{Binding DebugGameCommand}" InputGesture="Ctrl+F5" IsEnabled="{Binding !IsGameRunning}"/>
                <MenuItem Header="_Stop" Command="{Binding StopGameCommand}" InputGesture="Shift+F5" IsEnabled="{Binding IsGameRunning}"/>
            </MenuItem>
            <MenuItem Header="_Help">
                <MenuItem Header="_About Aihao"/>
            </MenuItem>
        </Menu>
        
        <!-- Toolbar -->
        <Border DockPanel.Dock="Top" Background="{StaticResource ToolbarBackgroundBrush}" Padding="1">
            <StackPanel Orientation="Horizontal" Spacing="1">
                <Button Content="ðŸ“‚" ToolTip.Tip="Open Project" Command="{Binding OpenProjectCommand}" Padding="3,1"/>
                <Button Content="ðŸ’¾" ToolTip.Tip="Save Project" Command="{Binding SaveProjectCommand}" IsEnabled="{Binding IsProjectLoaded}" Padding="3,1"/>
                <Separator/>
                <Button Content="ðŸ”¨" ToolTip.Tip="Build (Ctrl+Shift+B)" Command="{Binding BuildProjectCommand}" IsEnabled="{Binding IsProjectLoaded}" Padding="3,1"/>
                <Separator/>
                <Button Content="â–¶ï¸" ToolTip.Tip="Run (F5)" Command="{Binding RunGameCommand}" IsEnabled="{Binding IsProjectLoaded}" IsVisible="{Binding !IsGameRunning}" Padding="3,1"/>
                <Button Content="ðŸ›" ToolTip.Tip="Debug (Ctrl+F5)" Command="{Binding DebugGameCommand}" IsEnabled="{Binding IsProjectLoaded}" IsVisible="{Binding !IsGameRunning}" Padding="3,1"/>
                <Button Content="â¹ï¸" ToolTip.Tip="Stop (Shift+F5)" Command="{Binding StopGameCommand}" IsVisible="{Binding IsGameRunning}" Padding="3,1"/>
            </StackPanel>
        </Border>
        
        <!-- Status Bar -->
        <Border DockPanel.Dock="Bottom" Background="{StaticResource ToolbarBackgroundBrush}" Padding="4,1">
            <Grid ColumnDefinitions="*,Auto">
                <TextBlock Text="{Binding StatusMessage}" VerticalAlignment="Center"/>
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="{Binding Console.StatusText}" Opacity="0.7" VerticalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Main Content -->
        <Grid ColumnDefinitions="200,2,*,2,250" RowDefinitions="*,2,150">
            <!-- Left Panel: Project Tree -->
            <Border Grid.Column="0" Grid.RowSpan="3" Background="{StaticResource PanelBackgroundBrush}">
                <DockPanel>
                    <Border DockPanel.Dock="Top" Background="{StaticResource ToolbarBackgroundBrush}" Padding="4,1">
                        <TextBlock Text="Project" FontWeight="SemiBold"/>
                    </Border>
                    <views:ProjectTreeView DataContext="{Binding ProjectTree}"/>
                </DockPanel>
            </Border>
            
            <GridSplitter Grid.Column="1" Grid.RowSpan="3" ResizeDirection="Columns" Background="Transparent"/>
            
            <!-- Center: Document Tabs -->
            <Border Grid.Column="2" Grid.Row="0" Background="{StaticResource EditorBackgroundBrush}">
                <DockPanel>
                    <!-- Tab Strip -->
                    <Border DockPanel.Dock="Top" Background="{StaticResource ToolbarBackgroundBrush}">
                        <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                            <ItemsControl ItemsSource="{Binding OpenDocuments}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="vm:DocumentTabViewModel">
                                        <Border Padding="6,2" 
                                                Background="{Binding $parent[ItemsControl].((vm:MainWindowViewModel)DataContext).SelectedDocument, Converter={x:Static vm:SelectedTabConverter.Instance}, ConverterParameter={Binding}}"
                                                PointerPressed="OnTabPointerPressed">
                                            <StackPanel Orientation="Horizontal" Spacing="4">
                                                <TextBlock Text="{Binding Title}" VerticalAlignment="Center"/>
                                                <TextBlock Text="â—" IsVisible="{Binding IsDirty}" Foreground="Orange" VerticalAlignment="Center"/>
                                                <Button Content="Ã—" 
                                                        Padding="4,0"
                                                        Background="Transparent"
                                                        Command="{Binding $parent[ItemsControl].((vm:MainWindowViewModel)DataContext).CloseDocumentCommand}"
                                                        CommandParameter="{Binding}"
                                                        IsVisible="{Binding CanClose}"/>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Border>
                    
                    <!-- Document Content -->
                    <ContentControl Content="{Binding SelectedDocument.Content}">
                        <ContentControl.DataTemplates>
                            <DataTemplate DataType="{x:Type vm:GlobalSettingsEditorViewModel}">
                                <views:GlobalSettingsEditor/>
                            </DataTemplate>
                            <DataTemplate DataType="{x:Type vm:PropertiesEditorViewModel}">
                                <views:PropertiesEditor/>
                            </DataTemplate>
                            <DataTemplate DataType="{x:Type vm:ResourceListEditorViewModel}">
                                <views:ResourceListEditor/>
                            </DataTemplate>
                            <DataTemplate DataType="{x:Type vm:MetagenEditorViewModel}">
                                <views:MetagenEditor/>
                            </DataTemplate>
                            <DataTemplate DataType="{x:Type vm:OpenGLWindowViewModel}">
                                <views:OpenGLWindow/>
                            </DataTemplate>
                        </ContentControl.DataTemplates>
                    </ContentControl>
                </DockPanel>
            </Border>
            
            <GridSplitter Grid.Column="3" Grid.Row="0" ResizeDirection="Columns" Background="Transparent"/>
            
            <!-- Right Panel: Properties -->
            <Border Grid.Column="4" Grid.Row="0" Background="{StaticResource PanelBackgroundBrush}">
                <DockPanel>
                    <Border DockPanel.Dock="Top" Background="{StaticResource ToolbarBackgroundBrush}" Padding="4,1">
                        <TextBlock Text="Properties" FontWeight="SemiBold"/>
                    </Border>
                    <views:PropertiesEditor DataContext="{Binding Properties}"/>
                </DockPanel>
            </Border>
            
            <GridSplitter Grid.Column="2" Grid.ColumnSpan="3" Grid.Row="1" ResizeDirection="Rows" Background="Transparent"/>
            
            <!-- Bottom Panel: Console -->
            <Border Grid.Column="2" Grid.ColumnSpan="3" Grid.Row="2" Background="{StaticResource PanelBackgroundBrush}">
                <views:ConsoleWindow DataContext="{Binding Console}"/>
            </Border>
        </Grid>
    </DockPanel>
</Window>
